# Application Programming Interface (API)

The API closely follows the [command-line interface](./help/index.txt).  See [Design](./doc/design.md) for a detailed rationale behind the design.

For all message types below, `<version>=J9oN`.



# TODO

1. Ensure coherence of terminology usage

2. Complete missing operations

3. Revise for coherence, clarity, and simplicity



## Initialization

```js
var ssb = require('secret-stack')
ssb.use(require('ssb-tokens'))
// ex: ssb.tokens.create(...)
```

`ssb` is a currently running instance of SSB, accessible through [ssb-client](https://github.com/ssbc/ssb-client), that supports the following operations: (TODO)

## Operations

### Pre-conditions common to all operations

1. The private key of `owner` has been provided or is accessible.
2. `ssb` is correctly running.

### Terminology

#### *Unspent* tokens

*Def*: One or multiple `OPERATION_ID` , either created by `owner` ([SSB ID](./help/ssb.txt)) or that list `owner` as `recipient`,  whose tokens have not been completely given to other [SSB ID](./help/ssb.txt)s, or burnt. 

#### Operation

*Def:* The message generated by a `tokens.create`, `tokens.give`, or `tokens.burn` operation.

#### *Ancestor* operation

*Def*: Operation that is directly or transitively mentioned in the `source` of an operation.

#### *Root* operation

*Def:* `tokens.create` operation that is an *ancestor* of an operation.



### tokens.create(number, currency, ?options, ?cb)

Create `number` (Number) of type `currency` (String). 

The callback should have signature `cb(err)`. In that case, `success` is always `true`, and `err` is `false` if the operation was successful or `Error` (truthy) otherwise.

Options can be the following:

```js
{
  owner: SSB_ID || SSB_KEYS,       // Default: ".ssb/secret"
  description: SSB_MSG_ID || null, // Default: null
  "smallest-unit": Number          // Default: 0.01
}
```

where:

* `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is creating the tokens.
* `description`: is an [SSB Message ID](./help/ssb.txt) whose content describes the purpose and conditions of the tokens.
* `smallest-unit`: is a number that represents the smallest undivisible unit of the currency (ex: `0.01` for cents in `USD`).

#### => Log Effect(s)

`owner`'s log is extended with:

```json
{
  "type": "tokens/<version>/create", 
  "number": number,
  "currency": currency,
  "description": options.description,
  "smallest-unit": options["smallest-unit"]
}
```

The previous message is automatically assigned a `OPERATION_ID` by SSB, following the [SSB Message ID](./help/ssb.txt) format.

### tokens.give(tokens, recipient, ?options, ?cb)

Give `tokens` to `recipient` ([SSB ID](./help/ssb.txt)). 

`tokens` can be one of the followings:

* `OPERATION_ID`: gives all the remaining *unspent* tokens in `OPERATION_ID` if any, to `recipient`. Errors if none.

* `[ [number, OPERATION_ID], ...]`:  gives `number` tokens from transaction `OPERATION_ID` for each pair (sub-list) in the list.

* `null`:  automatically finds *unspent* tokens from transactions that match `options.currency` or `options.description`. Tokens are spent from oldest to newest.

The callback should have signature `cb(err)`. In that case, `success` is always `true`, and `err` is `false` if the operation was successful or truthy (Error) otherwise.

Options can be the following:

```js
{
  owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"
  currency: String,
  description: SSB_MSG_ID 
}
```

where:

* `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is giving the tokens.
* `currency` : is the currency (String) of previous [tokens.create](#tokens.create(number, currency, ?options, ?cb) => success) message(s). Automatically resolved to all previous  `OPERATION_ID`s of *unspent* tokens that match. Errors if `tokens` is not `null`.
* `description`: is the [SSB Message ID](./help/ssb.txt) of previous [tokens.create](#tokens.create(number, currency, ?options, ?cb) => success) message(s). Automatically resolved to all previous *unspent* tokens that match. Errors if `tokens` is not `null`.

#### Pre-conditions

Let `genesis` be the previous [tokens.create](#tokens.create(number, currency, ?options, ?cb) => success) message(s) reachable by following back transitively from `tokens`:

1. All `genesis` messages must have the same `currency` and `description`.
2. The total number of `tokens` spent in previous [tokens.give](tokens.give(number, source, recipient, ?options, ?cb) => success) messages of `owner` is less than the total number received.
3. `number` is a multiple of `genesis["smallest-unit"]`.
4. Every previous transaction reachable from `tokens` must be valid.

#### => Log Effect(s)

1. `owner`'s log is extended with the following message:

```json
{
  "type": "tokens/<version>/give",
  "source": [ [ number, OPERATION_ID ], ... ],
  "recipient": SSB_ID
}
```

The previous message is automatically assigned a `OPERATION_ID` by SSB, following the [SSB Message ID](./help/ssb.txt) format.

### tokens.burn(tokens, ?options, ?cb)

Burn (owned) `tokens`.

`tokens` can be one of the followings:

- `OPERATION_ID`

- `[ OPERATION_ID, ...]` (a list of `OPERATION_ID`)

The callback should have signature `cb(err)`. In that case, `success` is always `true`, and `err` is `false` if the operation was successful or truthy (Error) otherwise.

Options can be the following:

```js
{
  owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"
  description: null || SSB_MSG_ID     // Default: null
}
```

where:

- `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is giving the tokens.
- `description`: is a [SSB Message ID](./help/ssb.txt) that describes the purpose of the burn.

#### => Log Effect(s)

1. `owner`'s log is extended with the following message:

```json
{
  "type": "tokens/<version>/burn",
  "source": [ OPERATION_ID, ... ],
  "description": options.description
}
```

The previous message is automatically assigned a `OPERATION_ID` by SSB, following the [SSB Message ID](./help/ssb.txt) format.

### tokens.list(filter, owners, ?options, ?cb)

List tokens owned by `owners` that match one of the `filter`.

`filter` can be one of the followings:

* `OPERATION_ID`: show transactions with `OPERATION_ID` as an *ancestor*.

* `currency` (String): show transactions that match `currency`.

* `creation-description` ([SSB Message ID](./help/ssb.txt)): show only transactions that match `description`.

* `null`: show all transactions.

`owners` can be one of the followings:

* `SSB_ID`: show transactions of tokens owned by [SSB ID](./help/ssb.txt).

* `[SSB_ID, ...]`: show transactions of tokens owned by one of the listed [SSB ID](./help/ssb.txt).

* `null`: show transactions of tokens owned by anyone.

The callback should have signature `cb(err, result)`. In that case, `success` is always `true`, and `err` is `false` if the operation was successful or truthy (Error) otherwise. `result` is `[transaction, ...]` that match `filter` and `owners`. A `transaction` is the message of the operation that generated it (ex: `tokens.create`) augmented with `id: OPERATION_ID`.

Options can be the following:

```js
{
  status: 'spent' || 'unspent' || 'all',   // Default: 'unspent'
}
```

where:

- `status`: If `spent`, show only transactions with tokens completely spent. If `unspent`, show only transactions with *unspent* tokens.  If `all`, show all transactions.

#### => Log Effect(s): None

### tokens.trace(tokens,  ?options, ?cb)

#### => Log Effect(s): None

### tokens.flag(tokens, label, ?options, ?cb)

TODO: Should tokens.create use 'flag' instead of 'description'?

#### => Log Effect(s):
