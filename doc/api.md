# Application Programming Interface (API)

The API closely follows the [command-line interface](./help/index.txt).  See [Design](./doc/design.md) for a detailed rationale behind the design.

For all message types below, `<version>=J9oN`.

## Initialization

```js
    var ssb = require('secret-stack')
    ssb.use(require('ssb-tokens'))
    // ex: ssb.tokens.create(...)
```

`ssb` is a currently running instance of SSB, accessible through [ssb-client](https://github.com/ssbc/ssb-client), that supports the following operations: (TODO: Complete once implementation is working.)

## Operations

### Pre-conditions common to all operations

1. The private key of `owner` has been provided or is accessible.
2. `ssb` is correctly running.

### Terminology

#### *Unspent* tokens

*Def*: One or multiple [Operation ID](#operation-identifier), either created by `owner` (an [SSB ID](./help/ssb.txt)) or that list `owner` as `recipient`, in which tokens have not been: (1) completely given to other [SSB ID](./help/ssb.txt)s, or (2) burnt. 

#### Operation

*Def:* The message generated by a `tokens.create`, `tokens.give`, or `tokens.burn` operation.

#### Operation Identifier

*Def:* The identifier used to refer to an [operation](#operation).  Follows the [SSB Message ID](./help/ssb.txt) format.

#### Flag/Unflag Identifier

*Def:* The identifier used to refer to a [flag](#tokens.flag(tokens,-label,-?options,-cb))/[unflag](#tokens.unflag(tokens,-label,-options?,-cb)) message. Follows the [SSB Message ID](./help/ssb.txt) format.

#### *Ancestor* operation

*Def*: Operation that is directly or transitively mentioned in the `source` of an operation.

#### *Root* operations

*Def:* `tokens.create` operations that are *ancestors* of an operation.

### tokens.create(number, currency, ?options, cb)

Create `number` (Number) of type `currency` (String). 

The callback should have signature `cb(err)`. In that case, `err` is `null` if the operation was successful or `Error` (truthy) otherwise.

Options can be the following:

```js
{
    owner: SSB_ID || SSB_KEYS,       // Default: ".ssb/secret"
    description: SSB_MSG_ID || null, // Default: null
    "smallest-unit": Number          // Default: 0.01
}
```

where:

* `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is creating the tokens.
* `description`: is an [SSB Message ID](./help/ssb.txt) whose content describes the purpose and conditions of the tokens.
* `smallest-unit`: is a number that represents the smallest undivisible unit of the currency (ex: `0.01` for cents in `USD`).

#### => Log Effect(s)

`owner`'s log is extended with:

```json
{
    "type": "tokens/<version>/create", 
    "number": number,
    "currency": currency,
    "description": options.description,
    "smallest-unit": options["smallest-unit"]
}
```

The previous message is automatically assigned an [Operation_ID](#operation-identifier) by SSB.

### tokens.give(tokens, recipient, ?options, cb)

Give `tokens` to `recipient` ([SSB ID](./help/ssb.txt)). 

`tokens` can be one of the followings:

* `operation-id`: gives all the remaining [*unspent* tokens](#unspent-tokens) in [Operation ID](#operation-identifier) if any, to `recipient`. Errors if none.

* `[ [number, operation-id], ...]`:  gives `number` tokens from [Operation ID](#operation-identifier) for each pair (sub-list) in the list.

* `number` :  automatically finds [*unspent* tokens](#unspent-tokens) from [*root* operations](#root-operations) that match `options.currency` or `options.description`. Tokens are spent from oldest to newest.

The callback should have signature `cb(err)`. In that case, `success` is always `true`, and `err` is `false` if the operation was successful or truthy (Error) otherwise.

Options can be the following:

```js
{
    owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"
    currency: String,
    description: SSB_MSG_ID 
}
```

where:

* `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is giving the tokens.
* `currency` : is the currency (String) of [*root* operations](#root-operations). Automatically resolved to all previous [Operation ID](#operation-identifier)s of *unspent* tokens that match. Errors if `tokens` is not `null`.
* `description`: is the [SSB Message ID](./help/ssb.txt) of [*root* operations](#root-operations). Automatically resolved to all previous [*unspent* tokens](#unspent-tokens) that match. Errors if `tokens` is not `null`.

#### Pre-conditions

Let `roots` be the *roots* of `tokens`:

1. All `roots` must have the same `currency`, `description`, and `smallest-unit`.
2. The total number of `tokens` spent in previous [tokens.give](tokens.give(number, source, recipient, ?options, ?cb) => success) messages of `owner` is less than the total number received.
3. `number` is a multiple of `roots["smallest-unit"]`.
4. Every previous operation reachable from `tokens` must be valid, i.e. fulfill its pre-conditions.

#### => Log Effect(s)

1. `owner`'s log is extended with the following message:

```json
{
    "type": "tokens/<version>/give",
    "source": [ [ number, operation_id ], ... ],
    "recipient": SSB_ID
}
```

The previous message is automatically assigned an [Operation_ID](#operation-identifier) by SSB.

### tokens.burn(tokens, ?options, cb)

Burn (owned) `tokens`.

`tokens` can be one of the followings:

- `operation-id`

- `[ operation-id, ...]` (a list of [Operation ID](#operation-identifier))

The callback should have signature `cb(err)`.  `err` is `null` if the operation was successful or `Error` (truthy) otherwise.

Options can be the following:

```js
{
    owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"
    description: null || SSB_MSG_ID     // Default: null
}
```

where:

- `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is giving the tokens.
- `description`: is a [SSB Message ID](./help/ssb.txt) that describes the purpose of the burn.

#### Pre-conditions

Let `roots` be the *roots* of `tokens`:

1. All `roots` must have the same `currency`, `description`, and `smallest-unit`.
2. Every previous operation reachable from `tokens` must be valid, i.e. fulfill its pre-conditions.

#### => Log Effect(s)

1. `owner`'s log is extended with the following message:

```json
{
    "type": "tokens/<version>/burn",
    "source": [ operation_id, ... ],
    "description": options.description
}
```

The previous message is automatically assigned an [Operation_ID](#operation-identifier) by SSB.

### tokens.list(filter, owner, ?options, cb)

List tokens owned by `owner` that match `filter`.

`filter` can be one of the followings:

* `operation-id` ([SSB Message ID](./help/ssb.txt)): show operations that have [Operation ID](#operation-identifier) as an *ancestor*.

* `root-currency` (String): show operations whose *root*s' `currency` match `root-currency`.

* `root-description` ([SSB Message ID](./help/ssb.txt)): show only operations whose *roots'* `description` match `root-description`.

* `null`: show all operations.

`owner` can be one of the followings:

* `SSB_ID`: show operations of tokens owned by [SSB ID](./help/ssb.txt).

* `null`: show operations of tokens owned by anyone.

The callback should have signature `cb(err, result)`.  `err` is `null` if the operation was successful or `Error` (truthy) otherwise. `result` is `[operation, ...]` that match `filter` and `owner`. Each [operation](#operation) has the following properties added:

```javascript
{
    id: operation_id,
    flags: [ label, ... ]    
}  
```

`options` can be the following:

```js
{
    status: 'spent' || 'unspent' || 'all',   // Default: 'unspent'
}
```

where:

- `status`: If `spent`, show only [operations](#operation) with tokens completely spent. If `unspent`, show only operations with *unspent* tokens.  If `all`, show all operations.

#### => Log Effect(s): None

### tokens.trace(tokens,  ?options, cb)

Trace the history of `tokens`.

`tokens` can be one of the followings:

* `operation-id` ([SSB Message ID](./help/ssb.txt)): shows the *ancestors* of [Operation ID](#operation-identifier).

* `root-currency` (String): shows the *ancestors* of all [operations](#operation) whose *root*'s `currency` matches `root-currency`.
- `root-description` ([SSB Message ID](./help/ssb.txt)): show the ancestors of operations whose *roots'* `description` match `root-description`.

The callback should have signature `cb(err, traces)`. `err` is `null` if the operation was successful or `Error` (truthy) otherwise. `traces = [ trace, ...]` where each `trace` is a recursive tree of operations. For each operation, the [Operation ID](#operation-identifier) listed in `source` is replaced by the referred [operation](#operation), and the following properties are added:

```javascript
{
    id: operation_id,
    valid: true || Error(msg),
    flags: [ label, ... ]
}
```

where `operation_id` is the corresponding [Operation ID](#operation-identifier) and `valid` is `true` if all *ancestors* are valid and the operation fulfills its pre-conditions.

`options` can be the following:

```js
{
    status: 'spent' || 'unspent' || 'all',   // Default: 'unspent'
}
```

where:

- `status`: If `spent`, show only operations with tokens completely spent. If `unspent`, show only operations with *unspent* tokens. If `all`, show all operations. Ignored if `tokens = operation_id`.

#### => Log Effect(s): None

### tokens.flag(tokens, label, ?options, cb)

Flag `tokens` with `label`.

`tokens` is an [Operation ID](#operation-identifier).`label` is a String of 50 characters or less. The meaning of `label` is up to users/applications.

`options` can be the following:

```javascript
{
    owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"
    description: SSB_MSG_ID || null     // Defaults: null    
}
```

where:

* `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is creating the tokens.

* `description` is an optional [SSB Message ID](./help/ssb.txt) whose content describes the meaning of the label.

#### => Log Effect(s):

1. `owner`'s log is extended with the following message:

```json
{
    "type": "tokens/<version>/flag",
    "source": OPERATION_ID,
    "label": label,
    "description": options.description
}
```

The previous message is automatically assigned a [Flag_ID](#flag/unflag-identifier) by SSB.

### tokens.unflag(tokens, label, options?, cb)

Remove previously assigned flag `label` from `tokens`.

`tokens` is an [Operation ID](#operation-identifier).`label` is a String of 50 characters or less. The meaning of `label` is up to users/applications.

`options` can be the following:

```javascript
{
    owner: SSB_ID || SSB_KEYS,          // Default: ".ssb/secret"  
}
```

where:

- `owner`: is the [SSB ID](./help/ssb.txt) or [SSB Keys](https://github.com/ssbc/ssb-keys) that is creating the tokens.

#### => Log Effect(s):

1. `owner`'s log is extended with the following message:

```json
{
    "type": "tokens/<version>/unflag",
    "source": OPERATION_ID,
    "flag": FLAG_ID,
    "label": label
}
```

The previous message is automatically assigned a [Unflag_ID](#flag/unflag-identifier) by SSB.
